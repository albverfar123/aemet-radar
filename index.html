<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Visor precipitació</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
  html, body { height: 100%; margin: 0; }

  /* ================= HEADER ================= */
  .header {
    position: absolute; top: 0; left: 0; right: 0; height: 48px;
    background: #222; color: white; display: flex; align-items: center;
    padding: 0 16px; z-index: 2000; font-family: sans-serif;
  }
  .tab { margin-right: 18px; cursor: pointer; opacity: 0.7; transition: 0.3s; }
  .tab.active { opacity: 1; font-weight: bold; border-bottom: 2px solid #007bff; }

  /* ================= MAP ================= */
  #map { position: absolute; top: 48px; bottom: 0; width: 100%; background: #f0f0f0; }

  /* ================= CONTROL ================= */
  .control {
    position: absolute; top: 60px; right: 10px; background: white;
    padding: 14px; z-index: 1500; border-radius: 8px;
    font-size: 13px; font-family: sans-serif; width: 230px;
    box-shadow: 0 0 15px rgba(0,0,0,0.2);
  }

  .legend-box {
    background: white; padding: 12px; border-radius: 8px;
    font-size: 11px; font-family: sans-serif; width: 300px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
  }

  /* Estils barra de colors */
  .colorbar {
    height: 18px; width: 100%; border: 1px solid #777; margin-top: 8px;
    background: linear-gradient(to right, #00008F, #0000FF, #007FFF, #00FFFF, #7FFF7F, #FFFF00, #FF7F00, #FF0000, #7F0000);
  }

  .ticks-container { position: relative; width: 100%; height: 6px; }
  .tick { position: absolute; border-left: 1px solid #444; height: 100%; }
  
  .labels-container { position: relative; width: 100%; height: 16px; margin-top: 2px; }
  .label { position: absolute; transform: translateX(-50%); font-size: 10px; }

  .nav-arrows { display: flex; gap: 6px; margin-top: 6px; }
  .nav-arrows button { cursor: pointer; padding: 4px 10px; flex: 1; border: 1px solid #ccc; border-radius: 4px; }
  
  .status { font-size: 11px; margin-top: 8px; color: #444; font-weight: bold; }
  .week-label { font-size: 11px; margin-top: 4px; color: #007bff; font-weight: bold; }
  .info-box { margin-top: 10px; padding: 8px; background: #f8f9fa; border-radius: 6px; font-size: 11px; color: #555; line-height: 1.4; border-left: 3px solid #ddd; }

</style>
</head>

<body>

<div class="header">
  <div class="tab active" id="tabDaily">Acumulat diari</div>
  <div class="tab" id="tabWeekly">Acumulat setmanal</div>
  <div class="tab" id="tabReadme">README</div>
</div>

<div id="map"></div>

<div class="control">
  <div id="dailyControls">
    <b>Data:</b><br>
    <input id="datePicker" type="date" style="width: 100%; margin-top: 4px;">
    <div class="nav-arrows">
      <button id="prevDay">◀ Ant.</button>
      <button id="nextDay">Seg. ▶</button>
    </div>
    <div class="info-box">
      Acumulat 24h (00:00 - 23:59 UTC).<br>
      Escala logarítmica (0.1 a 200 mm).
    </div>
  </div>

  <div id="weeklyControls" style="display:none;">
    <b>Darrera setmana:</b><br>
    <input id="weekPicker" type="date" style="width: 100%; margin-top: 4px;">
    <div class="nav-arrows">
      <button id="prevWeek">◀ Ant.</button>
      <button id="nextWeek">Seg. ▶</button>
    </div>
    <div class="week-label" id="weekLabel"></div>
    <div class="info-box">
      Acumulat 7 dies (Dl a Dm).<br>
      Escala logarítmica (0.1 a 300 mm).
    </div>
  </div>

  <div class="status" id="statusMsg"></div>
  <br>
  Opacitat:<br>
  <input id="opacitySlider" type="range" min="0" max="1" step="0.05" value="0.7" style="width: 100%;">
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// =================================================
// CONFIG I CÀLCULS LOGARÍTMICS
// =================================================
let mode = "daily";
const imageBounds = [[40.0012309, -0.0015486], [43.1012309, 3.4984514]];

// Càlcul de posició percentual logarítmica: ((log(v) - log(min)) / (log(max) - log(min))) * 100
function getLogPos(val, min, max) {
    return ((Math.log10(val) - Math.log10(min)) / (Math.log10(max) - Math.log10(min))) * 100;
}

// =================================================
// MAPA
// =================================================
var map = L.map('map').setView([41.5, 1.5], 7);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

var overlay = null;
var legendControl = L.control({ position: "bottomright" });

legendControl.onAdd = function () {
    this._div = L.DomUtil.create("div", "legend-box");
    this.update();
    return this._div;
};

legendControl.update = function () {
    let min = 0.1, max, vals;
    
    if (mode === "daily") {
        max = 200;
        vals = [0.1, 1, 2, 5, 10, 20, 50, 100, 200];
    } else {
        max = 300;
        vals = [0.1, 3, 10, 25, 50, 100, 200, 300];
    }

    let ticksHtml = vals.map(v => `<span class="tick" style="left: ${getLogPos(v, min, max)}%"></span>`).join('');
    let labelsHtml = vals.map(v => {
        let align = v === max ? 'transform: translateX(-100%)' : '';
        return `<span class="label" style="left: ${getLogPos(v, min, max)}%; ${align}">${v}</span>`;
    }).join('');

    this._div.innerHTML = `
        <b>Precipitació Acumulada (mm)</b>
        <div class="colorbar"></div>
        <div class="ticks-container">${ticksHtml}</div>
        <div class="labels-container">${labelsHtml}</div>
    `;
};
legendControl.addTo(map);

// =================================================
// LOGICA DE CARREGA
// =================================================
function loadDaily(dateStr) {
    const yyyymmdd = dateStr.replaceAll("-", "");
    const pngPath = `png/GLD_RNN24H_${yyyymmdd}.png`;
    updateOverlay(pngPath, "✖ No hi ha acumulat diari disponible");
}

function loadWeekly(dateStr) {
    const d = new Date(dateStr);
    const day = d.getDay();
    const diff = 7 - (day === 0 ? 7 : day); // Fins diumenge
    d.setDate(d.getDate() + diff);
    const sunday = d.toISOString().slice(0,10);
    weekPicker.value = sunday;
    
    const end = new Date(sunday);
    const start = new Date(end); start.setDate(end.getDate() - 6);
    const opts = { day: '2-digit', month: 'short' };
    weekLabel.textContent = `${start.toLocaleDateString('ca-ES', opts)} - ${end.toLocaleDateString('ca-ES', opts)}`;

    const pngPath = `png/GLD_RNN7D_${sunday.replaceAll("-", "")}.png`;
    updateOverlay(pngPath, "✖ No hi ha acumulat setmanal disponible");
}

function updateOverlay(path, errorMsg) {
    statusMsg.textContent = "Carregant...";
    const img = new Image();
    img.onload = () => {
        if (overlay) map.removeLayer(overlay);
        overlay = L.imageOverlay(path, imageBounds, { opacity: opacitySlider.value }).addTo(map);
        statusMsg.style.color = "green";
        statusMsg.textContent = "✔ Dades carregades";
    };
    img.onerror = () => {
        if (overlay) map.removeLayer(overlay);
        statusMsg.style.color = "red";
        statusMsg.textContent = errorMsg;
    };
    img.src = path;
}

// =================================================
// ESDEVENIMENTS
// =================================================
const datePicker = document.getElementById("datePicker");
const weekPicker = document.getElementById("weekPicker");
const statusMsg = document.getElementById("statusMsg");
const opacitySlider = document.getElementById("opacitySlider");

function setMode(newMode) {
    mode = newMode;
    document.getElementById("tabDaily").classList.toggle("active", mode === "daily");
    document.getElementById("tabWeekly").classList.toggle("active", mode === "weekly");
    document.getElementById("dailyControls").style.display = mode === "daily" ? "block" : "none";
    document.getElementById("weeklyControls").style.display = mode === "weekly" ? "block" : "none";
    legendControl.update();
    mode === "daily" ? loadDaily(datePicker.value) : loadWeekly(weekPicker.value);
}

datePicker.addEventListener("change", e => loadDaily(e.target.value));
weekPicker.addEventListener("change", e => loadWeekly(e.target.value));
opacitySlider.oninput = (e) => { if (overlay) overlay.setOpacity(e.target.value); };

document.getElementById("prevDay").onclick = () => {
    let d = new Date(datePicker.value); d.setDate(d.getDate() - 1);
    datePicker.value = d.toISOString().slice(0,10); loadDaily(datePicker.value);
};
document.getElementById("nextDay").onclick = () => {
    let d = new Date(datePicker.value); d.setDate(d.getDate() + 1);
    datePicker.value = d.toISOString().slice(0,10); loadDaily(datePicker.value);
};
document.getElementById("prevWeek").onclick = () => {
    let d = new Date(weekPicker.value); d.setDate(d.getDate() - 7); loadWeekly(d.toISOString().slice(0,10));
};
document.getElementById("nextWeek").onclick = () => {
    let d = new Date(weekPicker.value); d.setDate(d.getDate() + 7); loadWeekly(d.toISOString().slice(0,10));
};

tabDaily.onclick = () => setMode("daily");
tabWeekly.onclick = () => setMode("weekly");

// Init
datePicker.value = new Date().toISOString().slice(0,10);
weekPicker.value = datePicker.value;
setMode("daily");

</script>
</body>
</html>








