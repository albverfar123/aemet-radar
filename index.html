<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Visor precipitaciÃ³</title>

<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>

<style>
  html, body, #map {
    height: 100%;
    margin: 0;
  }

  /* ================= HEADER ================= */
  .header {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 48px;
    background: #222;
    color: white;
    display: flex;
    align-items: center;
    padding: 0 16px;
    z-index: 2000;
    font-family: sans-serif;
  }

  .tab {
    margin-right: 18px;
    cursor: pointer;
    opacity: 0.7;
  }

  .tab.active {
    opacity: 1;
    font-weight: bold;
  }

  /* ================= MAP ================= */
  #map {
    position: absolute;
    top: 48px;
    bottom: 0;
    width: 100%;
  }

  /* ================= CONTROL ================= */
  .control {
    position: absolute;
    top: 60px;
    right: 10px;
    background: white;
    padding: 12px;
    z-index: 1500;
    border-radius: 8px;
    font-size: 13px;
    font-family: sans-serif;
  }

  .legend-box {
    background: white;
    padding: 10px;
    border-radius: 8px;
    font-size: 12px;
  }

  .nav-arrows {
    display: flex;
    gap: 6px;
    margin-top: 6px;
  }

  .nav-arrows button {
    cursor: pointer;
    padding: 2px 8px;
  }

  .status {
    font-size: 11px;
    margin-top: 6px;
    color: #444;
  }

  .week-label {
    font-size: 11px;
    margin-top: 4px;
    color: #333;
  }
</style>
</head>

<body>

<!-- ================= HEADER ================= -->
<div class="header">
  <div class="tab active" id="tabDaily">Acumulat diari</div>
  <div class="tab" id="tabWeekly">Acumulat setmanal</div>
  <div class="tab" id="tabReadme">README</div>
</div>

<div id="map"></div>

<!-- ================= CONTROL ================= -->
<div class="control">

  <div id="dailyControls">
    <b>Data:</b><br>
    <input id="datePicker" type="date">

    <div class="nav-arrows">
      <button id="prevDay">â—€</button>
      <button id="nextDay">â–¶</button>
    </div>
  </div>

  <div id="weeklyControls" style="display:none;">
    <b>Setmana (diumenge):</b><br>
    <input id="weekPicker" type="date">

    <div class="nav-arrows">
      <button id="prevWeek">â—€</button>
      <button id="nextWeek">â–¶</button>
    </div>

    <div class="week-label" id="weekLabel"></div>
  </div>

  <div class="status" id="statusMsg"></div>

  <br>
  Opacitat:<br>
  <input id="opacitySlider" type="range" min="0" max="1" step="0.05" value="0.7">

</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// =================================================
// CONFIG
// =================================================
let mode = "daily";

const imageBounds = [
  [40.0012309, -0.0015486],
  [43.1012309, 3.4984514]
];

// =================================================
// MAP
// =================================================
var map = L.map('map').setView([41.5, 1.5], 7);

L.tileLayer(
  'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
  { maxZoom: 19 }
).addTo(map);

map.fitBounds(imageBounds);

var overlay = null;
var legendControl = null;

// =================================================
// HELPERS
// =================================================
function formatDateToYYYYMMDD(dateStr) {
  return dateStr.replaceAll("-", "");
}

function getSunday(dateStr) {
  const d = new Date(dateStr);
  const day = d.getDay(); // 0=dg
  const diff = 7 - day;
  d.setDate(d.getDate() + (day === 0 ? 0 : diff));
  return d.toISOString().slice(0,10);
}

function formatWeekLabel(sundayStr) {
  const end = new Date(sundayStr);
  const start = new Date(end);
  start.setDate(end.getDate() - 6);

  const opts = { day: '2-digit', month: 'short', year: 'numeric' };
  return `${start.toLocaleDateString('ca-ES', opts)} â†’ ${end.toLocaleDateString('ca-ES', opts)}`;
}

// =================================================
// LEGEND
// =================================================
function updateLegend() {

  if (legendControl) {
    map.removeControl(legendControl);
  }

  const img = mode === "daily"
    ? "colorbar.png"
    : "colorbar_set.png";

  legendControl = L.control({ position: "bottomright" });

  legendControl.onAdd = function () {
    var div = L.DomUtil.create("div", "legend-box");
    div.innerHTML = `
      <b>PrecipitaciÃ³ (mm)</b><br>
      <img src="${img}" width="200">
    `;
    return div;
  };

  legendControl.addTo(map);
}

// =================================================
// LOADERS
// =================================================
function loadDaily(dateStr) {

  const yyyymmdd = formatDateToYYYYMMDD(dateStr);
  const pngPath = "png/GLD_RNN24H_" + yyyymmdd + ".png";

  statusMsg.textContent = "Carregantâ€¦";

  const img = new Image();

  img.onload = function () {

    if (overlay) map.removeLayer(overlay);

    overlay = L.imageOverlay(
      pngPath,
      imageBounds,
      { opacity: opacitySlider.value }
    ).addTo(map);

    statusMsg.textContent = "âœ” Dades disponibles";
  };

  img.onerror = () =>
    statusMsg.textContent = "âœ– No hi ha dades per aquest dia";

  img.src = pngPath;
}

function loadWeekly(dateStr) {

  const sunday = getSunday(dateStr);
  weekPicker.value = sunday;

  const yyyymmdd = formatDateToYYYYMMDD(sunday);
  const pngPath = "png/GLD_RNN7D_" + yyyymmdd + ".png";

  weekLabel.textContent = formatWeekLabel(sunday);

  statusMsg.textContent = "Carregantâ€¦";

  const img = new Image();

  img.onload = function () {

    if (overlay) map.removeLayer(overlay);

    overlay = L.imageOverlay(
      pngPath,
      imageBounds,
      { opacity: opacitySlider.value }
    ).addTo(map);

    statusMsg.textContent = "âœ” Dades disponibles";
  };

  img.onerror = () =>
    statusMsg.textContent = "âœ– No hi ha dades per aquesta setmana";

  img.src = pngPath;
}

// =================================================
// TAB SWITCH
// =================================================
function setMode(newMode) {

  mode = newMode;

  tabDaily.classList.toggle("active", mode === "daily");
  tabWeekly.classList.toggle("active", mode === "weekly");

  dailyControls.style.display = mode === "daily" ? "block" : "none";
  weeklyControls.style.display = mode === "weekly" ? "block" : "none";

  updateLegend();

  if (mode === "daily") {
    loadDaily(datePicker.value);
  } else {
    loadWeekly(weekPicker.value);
  }
}

// =================================================
// INIT
// =================================================
const datePicker = document.getElementById("datePicker");
const weekPicker = document.getElementById("weekPicker");
const statusMsg = document.getElementById("statusMsg");
const opacitySlider = document.getElementById("opacitySlider");
const weekLabel = document.getElementById("weekLabel");

datePicker.value = new Date().toISOString().slice(0,10);
weekPicker.value = datePicker.value;

updateLegend();
loadDaily(datePicker.value);

// =================================================
// EVENTS
// =================================================
datePicker.addEventListener("change", e => loadDaily(e.target.value));
weekPicker.addEventListener("change", e => loadWeekly(e.target.value));

opacitySlider.addEventListener("input", e => {
  if (overlay) overlay.setOpacity(e.target.value);
});

// arrows daily
prevDay.onclick = () => {
  const d = new Date(datePicker.value);
  d.setDate(d.getDate() - 1);
  datePicker.value = d.toISOString().slice(0,10);
  loadDaily(datePicker.value);
};

nextDay.onclick = () => {
  const d = new Date(datePicker.value);
  d.setDate(d.getDate() + 1);
  datePicker.value = d.toISOString().slice(0,10);
  loadDaily(datePicker.value);
};

// arrows weekly
prevWeek.onclick = () => {
  const d = new Date(weekPicker.value);
  d.setDate(d.getDate() - 7);
  loadWeekly(d.toISOString().slice(0,10));
};

nextWeek.onclick = () => {
  const d = new Date(weekPicker.value);
  d.setDate(d.getDate() + 7);
  loadWeekly(d.toISOString().slice(0,10));
};

// tabs
tabDaily.onclick = () => setMode("daily");
tabWeekly.onclick = () => setMode("weekly");
tabReadme.onclick = () => alert("README properament ðŸ˜‰");

</script>

</body>
</html>





